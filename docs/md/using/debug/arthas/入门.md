# 实践入门

## 快速入门

### 1. 启动一个测试服务

```sh
curl -O https://arthas.aliyun.com/math-game.jar
java -jar math-game.jar
```

`ath-game`是一个简单的程序，每隔一秒生成一个随机数，再执行质因数分解，并打印出分解结果。

### 2. 启动arthas

::: warning

使用和目标进程一致的用户启动，否则可能 attach 失败

:::

```sh
curl -O https://arthas.aliyun.com/arthas-boot.jar
java -jar arthas-boot.jar
```

输入指令之后会启动arthas并列出正在执行的Java程序，选择需要查看的进程。如下：

```sh
[root@iZ ~]# java -jar arthas-boot.jar 
[INFO] JAVA_HOME: /opt/jdk1.8.0_341/jre
[INFO] arthas-boot version: 3.6.7
[INFO] Found existing java process, please choose one and input the serial number of the process, eg : 1. Then hit ENTER.
* [1]: 8832 math-game.jar
```

输入1并回车，进入arthas面板：

![image-20230207164338150](https://raw.githubusercontent.com/ying010/pic-repo/master/img/2023/02/07/20230207-164339.png)

## 常用功能

### 1. 查看进程实时信息 dashboard

`dashboard`可以查看当前进程实时信息，滚动展示，按`ctrl+c`中断执行。

![image-20230207164847813](https://raw.githubusercontent.com/ying010/pic-repo/master/img/2023/02/07/20230207-164848.png)

### 2. 获取进程的Main入口

```sh
thread 1 | grep 'main('
```

`thread`指令可以打印线程信息，ID=1的线程通常为main方法所在线程。

![image-20230207165436483](https://raw.githubusercontent.com/ying010/pic-repo/master/img/2023/02/07/20230207-165437.png)

### 3. 代码反编译

`jad`指令可以反编译代码。可以查看线上代码是否为预期代码，是否被覆盖或未上线。

```sh
[arthas@8832]$ jad demo.MathGame

ClassLoader:                                                                                                                                                                                                                                                                  
+-sun.misc.Launcher$AppClassLoader@70dea4e                                                                                                                                                                                                                                    
  +-sun.misc.Launcher$ExtClassLoader@360878cf                                                                                                                                                                                                                                 

Location:                                                                                                                                                                                                                                                                     
/root/math-game.jar                                                                                                                                                                                                                                                           

       /*
        * Decompiled with CFR.
        */
       package demo;
       
       import java.util.ArrayList;
       import java.util.List;
       import java.util.Random;
       import java.util.concurrent.TimeUnit;
       
       public class MathGame {
           private static Random random = new Random();
           private int illegalArgumentCount = 0;
       
           public List<Integer> primeFactors(int number) {
/*44*/         if (number < 2) {
/*45*/             ++this.illegalArgumentCount;
                   throw new IllegalArgumentException("number is: " + number + ", need >= 2");
               }
               ArrayList<Integer> result = new ArrayList<Integer>();
/*50*/         int i = 2;
/*51*/         while (i <= number) {
/*52*/             if (number % i == 0) {
/*53*/                 result.add(i);
/*54*/                 number /= i;
/*55*/                 i = 2;
                       continue;
                   }
/*57*/             ++i;
               }
/*61*/         return result;
           }
       
           public static void main(String[] args) throws InterruptedException {
               MathGame game = new MathGame();
               while (true) {
/*16*/             game.run();
/*17*/             TimeUnit.SECONDS.sleep(1L);
               }
           }
       
           public void run() throws InterruptedException {
               try {
/*23*/             int number = random.nextInt() / 10000;
/*24*/             List<Integer> primeFactors = this.primeFactors(number);
/*25*/             MathGame.print(number, primeFactors);
               }
               catch (Exception e) {
/*28*/             System.out.println(String.format("illegalArgumentCount:%3d, ", this.illegalArgumentCount) + e.getMessage());
               }
           }
       
           public static void print(int number, List<Integer> primeFactors) {
               StringBuffer sb = new StringBuffer(number + "=");
/*34*/         for (int factor : primeFactors) {
/*35*/             sb.append(factor).append('*');
               }
/*37*/         if (sb.charAt(sb.length() - 1) == '*') {
/*38*/             sb.deleteCharAt(sb.length() - 1);
               }
/*40*/         System.out.println(sb);
           }
       }

Affect(row-cnt:1) cost in 1002 ms.
[arthas@8832]$ 

```

### 4. 监听函数返回值

`watch`指令可以监听程序的运行，可以在程序运行期间查看函数的入参、返回值、抛出异常等，再不加日志的情况下就能方便定位问题。以监听函数返回值为例：

```sh
[arthas@8832]$ watch demo.MathGame primeFactors returnObj
Press Q or Ctrl+C to abort.
Affect(class count: 1 , method count: 1) cost in 157 ms, listenerId: 1
method=demo.MathGame.primeFactors location=AtExceptionExit
ts=2023-02-07 16:59:00; [cost=1.048227ms] result=null
method=demo.MathGame.primeFactors location=AtExceptionExit
ts=2023-02-07 16:59:01; [cost=0.048835ms] result=null
method=demo.MathGame.primeFactors location=AtExit
ts=2023-02-07 16:59:02; [cost=1.144238ms] result=@ArrayList[
    @Integer[2],
    @Integer[64433],
]
method=demo.MathGame.primeFactors location=AtExit
ts=2023-02-07 16:59:03; [cost=0.027143ms] result=@ArrayList[
    @Integer[7],
    @Integer[19],
    @Integer[191],
]
method=demo.MathGame.primeFactors location=AtExceptionExit
ts=2023-02-07 16:59:04; [cost=0.053625ms] result=null
method=demo.MathGame.primeFactors location=AtExceptionExit
ts=2023-02-07 16:59:05; [cost=0.047201ms] result=null
method=demo.MathGame.primeFactors location=AtExceptionExit
ts=2023-02-07 16:59:06; [cost=0.046098ms] result=null
[arthas@8832]$ 
```

### 5. 退出 arthas

如果只是退出当前的连接，可以用`quit`或者`exit`命令。Attach 到目标进程上的 arthas 还会继续运行，端口会保持开放，下次连接时可以直接连接上。

如果想完全退出 arthas，可以执行`stop`命令。
