# Java漏洞

## StringBuilder

### 描述

将用户控制的数据附加到使用默认支持字符数组大小 (16) 进行初始化的 `StringBuilder` 或 `StringBuffer` 实例，会导致应用程序在调整基础数组的大小以适应用户数据时占用大量堆内存。将数据附加到 `StringBuilder` 或 `StringBuffer` 实例上时，实例将确定支持字符数组是否有足够的可用空间来存储数据。如果数据不合适，`StringBuilder` 或 `StringBuffer` 实例将会创建新的数组，其容量至少为以前数组大小的两倍，而旧数组在进行回收之前，将继续留在堆中。攻击者可以利用此实现详细信息执行 Denial of Service (DoS) 攻击。

**示例 1：**用户控制的数据附加到使用默认构造函数进行初始化的 `StringBuilder` 实例。

```java
    ...
    StringBuilder sb = new StringBuilder();
    final String lineSeparator = System.lineSeparator();
    String[] labels = request.getParameterValues("label");
    for (String label : labels) {
        sb.append(label).append(lineSeparator);
    }
    ...
```

### 建议

使用预期附加数据大小的初始容量初始化 `StringBuilder` 或 `StringBuffer`，以减少调整支持数组大小的次数。在将数据附加到 `StringBuilder` 或 `StringBuffer` 实例前，检查数据大小。

**示例 2：**用户控制的数据附加到使用初始容量构造函数进行初始化的 `StringBuilder` 实例，且在附加之前会对数据长度进行检查以确保不会超过初始 `StringBuilder` 容量，从而避免调整支持数组大小。

```java
    ...
    private final int BUFFER_CAPACITY = 5200;
    StringBuilder sb = new StringBuilder(BUFFER_CAPACITY);
    ...
    final String lineSeparator = System.lineSeparator();
    String[] labels = request.getParameterValues("label");
    for (String label : labels) {
        if (label.length() + lineSeparator.length() + sb.length() <= sb.capacity()) {
            sb.append(label).append(lineSeparator);
        } else {
            // Handle error
        }
    }
    ...
```

**示例 3：**将用户控制的数据附加到使用初始容量构造函数进行初始化的 `StringBuffer` 实例，并检查字符串长度和数据项的数量，以限制可以附加到 `StringBuffer` 的数据量。

```java
    ...
    private final int MAX_LABEL_LEN = 50;
    private final int MAX_LABEL_ITEMS = 100;
    private final int BUFFER_CAPACITY = 5200;
    StringBuffer sb = new StringBuffer(BUFFER_CAPACITY);
    ...
    final String lineSeparator = System.lineSeparator();
    String[] labels = request.getParameterValues("label");
    if (labels.length <= MAX_LABEL_ITEMS) {
        for (String label : labels) {
            if (label.length() <= MAX_LABEL_LEN) {
                sb.append(label).append(lineSeparator);
            } else {
                // Handle error
            }
        }
    } else {
        // Handle error
    }
    ...
```